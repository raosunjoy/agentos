# AgentOS AOSP Build Environment Dockerfile
FROM ubuntu:22.04

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install AOSP build dependencies
RUN apt-get update && apt-get install -y \
    # Essential build tools
    git-core gnupg flex bison build-essential zip curl zlib1g-dev \
    gcc-multilib g++-multilib libc6-dev-i386 libncurses5 \
    lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev \
    libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig \
    # Python and repo tool
    python3 python3-pip python-is-python3 \
    # Additional tools
    rsync bc schedtool \
    # ccache for faster builds
    ccache \
    # Git LFS
    git-lfs \
    && rm -rf /var/lib/apt/lists/*

# Install repo tool
RUN curl https://storage.googleapis.com/git-repo-downloads/repo > /usr/local/bin/repo \
    && chmod a+x /usr/local/bin/repo

# Set up ccache
ENV USE_CCACHE=1
ENV CCACHE_DIR=/ccache
ENV CCACHE_MAXSIZE=50G

# Create ccache directory
RUN mkdir -p /ccache && chmod 777 /ccache

# Set up build environment
ENV JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
ENV PATH=${PATH}:${JAVA_HOME}/bin

# Install OpenJDK 11 (required for AOSP)
RUN apt-get update && apt-get install -y openjdk-11-jdk \
    && rm -rf /var/lib/apt/lists/*

# Create build user
RUN useradd -m -s /bin/bash aosp \
    && usermod -aG sudo aosp \
    && echo "aosp ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Switch to build user
USER aosp
WORKDIR /home/aosp

# Set up Git configuration for AOSP
RUN git config --global user.name "AgentOS Builder" \
    && git config --global user.email "builder@agentos.org" \
    && git config --global color.ui auto

# Install Git LFS
RUN git lfs install

# Create AOSP source directory
RUN mkdir -p /aosp

# Set working directory
WORKDIR /aosp

# Default command
CMD ["/bin/bash"]